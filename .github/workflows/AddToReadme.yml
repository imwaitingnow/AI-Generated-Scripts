name: Auto-Generate Scripts by Site Section

on:
  push:
    paths:
      - 'sites/**'
    branches:
      - main

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # Build the Scripts by Site section dynamically
      - name: Build Scripts by Site section
        run: |
          tmp=$(mktemp)
          echo "## Scripts by SiteðŸŒ" > "$tmp" && echo >> "$tmp"

          for site in $(find sites -mindepth 1 -maxdepth 1 -type d | sort); do
            site_name=$(basename "$site")
            echo "### [${site_name}](./sites/$site_name)" >> "$tmp"

            find "$site" \( -type d -o -name "*.user.js" \) | sort | while read path; do
              rel=${path#./}
              depth=$(( $(echo "$rel" | grep -o "/" | wc -l) - 1 ))
              indent=$(printf '  %.0s' $(seq 1 $depth))

              if [ -d "$path" ] && [[ "$(basename "$path")" != "$site_name" ]]; then
                name=$(basename "$path")
                echo "${indent}- **[${name}](./$rel)**" >> "$tmp"
              elif [[ "$path" == *.user.js ]]; then
                name=$(basename "$path")
                display=$(grep -m1 "^// @name" "$path" | sed 's|// @name[[:space:]]*||')
                desc=$(grep -m1 "^// @description" "$path" | sed 's|// @description[[:space:]]*||')
                [[ -z "$display" ]] && display="$name"
                if [ -n "$desc" ]; then
                  echo "${indent}- [${display}](./$rel) â€” ${desc}" >> "$tmp"
                else
                  echo "${indent}- [${display}](./$rel)" >> "$tmp"
                fi
              fi
            done
            echo >> "$tmp"
          done

          awk '
            BEGIN{in=0}
            /^## Scripts by SiteðŸŒ/{print;system("tail -n +2 '"$tmp"'");in=1;next}
            /^## / && in{in=0}
            !in
          ' README.md > README.new
          mv README.new README.md

      - name: Commit changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          if ! git diff --quiet; then
            git add -A
            git commit -m "chore: update Scripts by Site section"
            git push
          else
            echo "No changes."
          fi
